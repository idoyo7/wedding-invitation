name: Build and Push Docker Image (No Cache)

on:
  push:
    branches: [ main, master ]
    paths-ignore:
      - 'README.md'
      - '.gitignore'
      - 'docs/**'
  pull_request:
    branches: [ main, master ]
  workflow_dispatch: # ìˆ˜ë™ íŠ¸ë¦¬ê±° í—ˆìš©

env:
  # Docker Hub (ê¸°ë³¸ registry)
  IMAGE_NAME: montkim9/wedding-invitation
  # montstrap ë ˆí¬ì§€í† ë¦¬ ê²½ë¡œ
  MONTSTRAP_REPO: idoyo7/montstrap
  MONTSTRAP_PATH: montstrap/wedding-invitation/manifests/deployment.yaml

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    environment: production
    permissions:
      contents: write # montstrap ë ˆí¬ì§€í† ë¦¬ì— í‘¸ì‹œí•˜ê¸° ìœ„í•´ í•„ìš”
      packages: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Extract short SHA
      id: vars
      run: echo "SHORT_SHA=${GITHUB_SHA:0:6}" >> $GITHUB_ENV

    - name: Log in to Docker Hub
      if: github.event_name != 'pull_request'
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}

    - name: Build and push Docker image
      if: github.event_name != 'pull_request'
      uses: docker/build-push-action@v5
      with:
        context: .
        platforms: linux/amd64
        push: true
        build-args: |
          NEXT_PUBLIC_NAVER_MAP_CLIENT_ID=${{ secrets.NEXT_PUBLIC_NAVER_MAP_CLIENT_ID }}
        tags: |
          ${{ env.IMAGE_NAME }}:${{ env.SHORT_SHA }}
          ${{ env.IMAGE_NAME }}:latest
        
    - name: Build Docker image (Pull Request)
      if: github.event_name == 'pull_request'
      uses: docker/build-push-action@v5
      with:
        context: .
        platforms: linux/amd64
        push: false
        build-args: |
          NEXT_PUBLIC_NAVER_MAP_CLIENT_ID=test_key_for_pr

    - name: Build Summary
      if: always() # í•­ìƒ ì‹¤í–‰
      run: |
        echo "### ðŸ“¦ Wedding Invitation Docker Image Build Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Image Tags:**" >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
        if [ "${{ github.event_name }}" != "pull_request" ]; then
          echo "${{ env.IMAGE_NAME }}:${{ env.SHORT_SHA }}" >> $GITHUB_STEP_SUMMARY
          if [ "${{ github.ref }}" = "refs/heads/main" ]; then
            echo "${{ env.IMAGE_NAME }}:latest" >> $GITHUB_STEP_SUMMARY
          fi
        else
          echo "${{ env.IMAGE_NAME }}:pr-${{ github.event.pull_request.number }}" >> $GITHUB_STEP_SUMMARY
        fi
        echo '```' >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Registry:** \`Docker Hub\`" >> $GITHUB_STEP_SUMMARY
        echo "**Repository:** \`${{ env.IMAGE_NAME }}\`" >> $GITHUB_STEP_SUMMARY
        echo "**SHA:** \`${{ env.SHORT_SHA }}\`" >> $GITHUB_STEP_SUMMARY
        echo "**Platform:** \`linux/amd64\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

  # montstrap ë§¤ë‹ˆíŽ˜ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
  update-manifests:
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    needs: build-and-push
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
    - name: Checkout montstrap repository
      uses: actions/checkout@v4
      with:
        repository: ${{ env.MONTSTRAP_REPO }}
        token: ${{ secrets.PERSONAL_GITHUB_TOKEN }}
        path: montstrap

    - name: Update deployment manifest
      id: update-manifest
      run: |
        echo "ðŸš€ Updating deployment manifest..."
        cd montstrap
        
        MANIFEST_DIR="wedding-invitation/manifests"
        MANIFEST_FILE="${MANIFEST_DIR}/deployment.yaml"
        NEW_IMAGE="${{ env.IMAGE_NAME }}:${{ env.SHORT_SHA }}"
        
        echo "Target: ${MANIFEST_FILE}"
        echo "New image: ${NEW_IMAGE}"
        
        # ë””ë ‰í† ë¦¬ ìƒì„±
        mkdir -p "${MANIFEST_DIR}"
        
        # deployment.yaml ìƒì„± ë˜ëŠ” ì—…ë°ì´íŠ¸
        if [ ! -f "${MANIFEST_FILE}" ]; then
          echo "Creating new deployment.yaml..."
          echo "apiVersion: apps/v1" > "${MANIFEST_FILE}"
          echo "kind: Deployment" >> "${MANIFEST_FILE}"
          echo "metadata:" >> "${MANIFEST_FILE}"
          echo "  name: wedding-invitation" >> "${MANIFEST_FILE}"
          echo "  namespace: wedding-invitation" >> "${MANIFEST_FILE}"
          echo "  labels:" >> "${MANIFEST_FILE}"
          echo "    app: wedding-invitation" >> "${MANIFEST_FILE}"
          echo "spec:" >> "${MANIFEST_FILE}"
          echo "  replicas: 2" >> "${MANIFEST_FILE}"
          echo "  selector:" >> "${MANIFEST_FILE}"
          echo "    matchLabels:" >> "${MANIFEST_FILE}"
          echo "      app: wedding-invitation" >> "${MANIFEST_FILE}"
          echo "  template:" >> "${MANIFEST_FILE}"
          echo "    metadata:" >> "${MANIFEST_FILE}"
          echo "      labels:" >> "${MANIFEST_FILE}"
          echo "        app: wedding-invitation" >> "${MANIFEST_FILE}"
          echo "    spec:" >> "${MANIFEST_FILE}"
          echo "      containers:" >> "${MANIFEST_FILE}"
          echo "        - name: wedding-invitation" >> "${MANIFEST_FILE}"
          echo "          image: ${NEW_IMAGE}" >> "${MANIFEST_FILE}"
          echo "          ports:" >> "${MANIFEST_FILE}"
          echo "            - containerPort: 3000" >> "${MANIFEST_FILE}"
          echo "âœ… Created new deployment.yaml"
        else
          echo "Updating existing deployment.yaml..."
          sed -i "s|image: montkim9/wedding-invitation:.*|image: ${NEW_IMAGE}|g" "${MANIFEST_FILE}"
          echo "âœ… Updated existing deployment.yaml"
        fi
        
        echo "ðŸ“‹ Final deployment.yaml:"
        cat "${MANIFEST_FILE}"
        
        # Git ë³€ê²½ì‚¬í•­ í™•ì¸
        git add "${MANIFEST_FILE}"
        if git diff --cached --quiet; then
          echo "changes_made=false" >> $GITHUB_OUTPUT
        else
          echo "changes_made=true" >> $GITHUB_OUTPUT
        fi

    - name: Commit and push changes
      if: steps.update-manifest.outputs.changes_made == 'true'
      run: |
        echo "ðŸ’¾ Committing changes..."
        cd montstrap
        
        git config user.name "${{ github.actor }}"
        git config user.email "${{ github.actor }}@users.noreply.github.com"
        
        git commit -m "ðŸš€ Update wedding-invitation image to ${{ env.SHORT_SHA }}"
        
        echo "ðŸš€ Pushing to repository..."
        git push
        
    - name: Update Summary
      if: always()
      run: |
        echo "### ðŸš€ Deployment Manifest Update Status" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        if [ "${{ steps.update-manifest.outputs.changes_made }}" == "true" ]; then
          echo "âœ… **Successfully updated** \`${{ env.MONTSTRAP_PATH }}\` with image tag \`${{ env.IMAGE_NAME }}:${{ env.SHORT_SHA }}\`." >> $GITHUB_STEP_SUMMARY
          echo "The changes have been committed and pushed to \`${{ env.MONTSTRAP_REPO }}\`." >> $GITHUB_STEP_SUMMARY
        else
          echo "â„¹ï¸ No changes were needed for \`${{ env.MONTSTRAP_PATH }}\`." >> $GITHUB_STEP_SUMMARY
        fi
        echo "" >> $GITHUB_STEP_SUMMARY

  # ë°°í¬ ì¤€ë¹„ ì™„ë£Œ ì•Œë¦¼
  deploy-ready:
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    needs: [build-and-push, update-manifests]
    runs-on: ubuntu-latest
    
    steps:
    - name: Deploy notification
      run: |
        echo "### ðŸŽ‰ Wedding Invitation - Deployment Ready" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "The Docker image has been built and pushed to the registry, and the deployment manifest has been updated." >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Image Tag:** \`${{ env.IMAGE_NAME }}:latest\` (or \`${{ env.IMAGE_NAME }}:${{ env.SHORT_SHA }}\`)" >> $GITHUB_STEP_SUMMARY
        echo "**Manifest Updated:** \`${{ env.MONTSTRAP_REPO }}/${{ env.MONTSTRAP_PATH }}\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

  # ì‹¤íŒ¨ ì•Œë¦¼
  failure-notification:
    if: failure()
    needs: [build-and-push, update-manifests]
    runs-on: ubuntu-latest
    steps:
      - name: Send Failure Notification
        run: |
          echo "### âŒ CI/CD Pipeline Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The Wedding Invitation CI/CD pipeline has failed." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Workflow Run:** [${{ github.run_id }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** \`${GITHUB_SHA:0:8}\`" >> $GITHUB_STEP_SUMMARY
