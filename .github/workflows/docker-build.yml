name: Build and Push Docker Image

on:
  push:
    branches: [ main, master ]
    paths-ignore:
      - 'README.md'
      - '.gitignore'
      - 'docs/**'
  pull_request:
    branches: [ main, master ]
  workflow_dispatch: # ìˆ˜ë™ íŠ¸ë¦¬ê±° í—ˆìš©

env:
  # Docker Hub (ê¸°ë³¸ registry)
  IMAGE_NAME: ${{ secrets.DOCKER_USERNAME }}/wedding-invitation

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    environment: production
    permissions:
      contents: read
      packages: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      with:
        driver-opts: image=moby/buildkit:master

    - name: Cache Docker layers
      uses: actions/cache@v4
      with:
        path: /tmp/.buildx-cache
        key: ${{ runner.os }}-buildx-${{ github.sha }}
        restore-keys: |
          ${{ runner.os }}-buildx-

    - name: Cache Node.js dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.npm
          ${{ github.workspace }}/node_modules
          ${{ github.workspace }}/.next/cache
        key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
        restore-keys: |
          ${{ runner.os }}-node-

    - name: Extract short SHA
      id: vars
      run: echo "SHORT_SHA=${GITHUB_SHA::6}" >> $GITHUB_ENV

    - name: Log in to Docker Hub
      if: github.event_name != 'pull_request'
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}

    - name: Build and push Docker image
      if: github.event_name != 'pull_request'
      uses: docker/build-push-action@v5
      with:
        context: .
        platforms: linux/amd64,linux/arm64
        push: true
        build-args: |
          NEXT_PUBLIC_NAVER_MAP_CLIENT_ID=${{ secrets.NEXT_PUBLIC_NAVER_MAP_CLIENT_ID }}
        tags: |
          ${{ env.IMAGE_NAME }}:${{ env.SHORT_SHA }}
          ${{ github.ref == 'refs/heads/main' && format('{0}:latest', env.IMAGE_NAME) || '' }}
        cache-from: |
          type=local,src=/tmp/.buildx-cache
          type=registry,ref=${{ env.IMAGE_NAME }}:cache
        cache-to: |
          type=local,dest=/tmp/.buildx-cache-new,mode=max
          type=registry,ref=${{ env.IMAGE_NAME }}:cache,mode=max
        
    - name: Move cache  
      if: github.event_name != 'pull_request'
      run: |
        rm -rf /tmp/.buildx-cache
        mv /tmp/.buildx-cache-new /tmp/.buildx-cache

    - name: Build Docker image (Pull Request)
      if: github.event_name == 'pull_request'
      uses: docker/build-push-action@v5
      with:
        context: .
        platforms: linux/amd64
        push: false
        build-args: |
          NEXT_PUBLIC_NAVER_MAP_CLIENT_ID=test_key_for_pr
        cache-from: |
          type=local,src=/tmp/.buildx-cache
          type=registry,ref=${{ env.IMAGE_NAME }}:cache
        cache-to: type=local,dest=/tmp/.buildx-cache-new,mode=max

    - name: Move cache (Pull Request)
      if: github.event_name == 'pull_request'  
      run: |
        rm -rf /tmp/.buildx-cache
        mv /tmp/.buildx-cache-new /tmp/.buildx-cache

    - name: Build Summary
      if: always()
      run: |
        echo "### ðŸ“¦ Wedding Invitation Docker Build Report" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ github.event_name }}" != "pull_request" ]; then
          echo "**âœ… Build Status:** Complete (Pushed to Registry)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**ðŸ“‹ Image Tags:**" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "${{ env.IMAGE_NAME }}:${{ env.SHORT_SHA }}" >> $GITHUB_STEP_SUMMARY
          echo "${{ env.IMAGE_NAME }}:latest" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
        else
          echo "**âœ… Build Status:** Test Build Complete (Not Pushed)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**ðŸ” Pull Request Build:** Image built successfully but not pushed to registry" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**ðŸš€ Performance Optimizations:**" >> $GITHUB_STEP_SUMMARY
        echo "- âš¡ Docker layer caching enabled" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ“¦ Registry cache enabled (\`${{ env.IMAGE_NAME }}:cache\`)" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ—ï¸ Multi-platform build (linux/amd64, linux/arm64)" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ—‚ï¸ Node.js dependencies cached" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**ðŸ“Š Build Info:**" >> $GITHUB_STEP_SUMMARY  
        echo "- **Repository:** \`${{ env.IMAGE_NAME }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- **SHA:** \`${{ env.SHORT_SHA }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- **Platform:** \`${{ runner.os }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- **Buildx:** \`Enabled with cache\`" >> $GITHUB_STEP_SUMMARY

  # montstrap ë§¤ë‹ˆíŽ˜ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
  update-manifests:
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    needs: build-and-push
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
    - name: Extract short SHA
      id: vars
      run: echo "SHORT_SHA=${GITHUB_SHA::6}" >> $GITHUB_ENV

    - name: Checkout montstrap repository
      uses: actions/checkout@v4
      with:
        repository: idoyo7/montstrap
        token: ${{ secrets.PERSONAL_GITHUB_TOKEN }}
        path: montstrap

    - name: Debug montstrap repository structure
      run: |
        cd montstrap
        echo "ðŸ“ Montstrap repository structure:"
        ls -la
        echo ""
        echo "ðŸ” Looking for existing wedding-invitation directory:"
        ls -la wedding-invitation/ 2>/dev/null || echo "wedding-invitation directory not found (will be created)"

    - name: Update deployment manifest
      run: |
        cd montstrap
        
        # ë””ë ‰í† ë¦¬ ìƒì„± (ì—†ì„ ê²½ìš°)
        mkdir -p wedding-invitation/manifests
        
        # deployment.yaml íŒŒì¼ì´ ì—†ìœ¼ë©´ ìƒì„±
        if [ ! -f "wedding-invitation/manifests/deployment.yaml" ]; then
          echo "ðŸ“ Creating new deployment.yaml file..."
          cat > wedding-invitation/manifests/deployment.yaml << EOF
        apiVersion: apps/v1
        kind: Deployment
        metadata:
          name: wedding-invitation
          namespace: wedding-invitation
          labels:
            app: wedding-invitation
        spec:
          replicas: 2
          revisionHistoryLimit: 2
          selector:
            matchLabels:
              app: wedding-invitation
          template:
            metadata:
              labels:
                app: wedding-invitation
            spec:
              containers:
                - name: wedding-invitation
                  image: montkim9/wedding-invitation:latest
                  ports:
                    - containerPort: 3000
        EOF
          echo "âœ… Created new deployment.yaml"
        else
          echo "ðŸ“„ Found existing deployment.yaml"
        fi
        
        # í˜„ìž¬ ì´ë¯¸ì§€ íƒœê·¸ í™•ì¸
        echo "Current deployment.yaml content:"
        grep -n "image:" wedding-invitation/manifests/deployment.yaml || echo "No image line found"
        
        # ì´ë¯¸ì§€ íƒœê·¸ ì—…ë°ì´íŠ¸
        sed -i 's|image: montkim9/wedding-invitation:.*|image: montkim9/wedding-invitation:${{ env.SHORT_SHA }}|' wedding-invitation/manifests/deployment.yaml
        
        # ë³€ê²½ì‚¬í•­ í™•ì¸
        echo ""
        echo "âœ… Updated deployment.yaml:"
        grep -n "image:" wedding-invitation/manifests/deployment.yaml

    - name: Commit and push changes to montstrap
      run: |
        cd montstrap
        
        # Git ì„¤ì •
        git config user.name "${{ github.actor }}"
        git config user.email "${{ github.actor }}@users.noreply.github.com"
        
        # ë³€ê²½ì‚¬í•­ í™•ì¸
        if git diff --quiet wedding-invitation/manifests/deployment.yaml; then
          echo "âš ï¸ No changes detected in deployment.yaml"
          echo "This might indicate the tag was already up to date or the sed command failed"
          exit 1
        fi
        
        # ë³€ê²½ì‚¬í•­ ìŠ¤í…Œì´ì§• ë° ì»¤ë°‹
        git add wedding-invitation/manifests/deployment.yaml
        
        # ì»¤ë°‹ ë©”ì‹œì§€ì— ë” ë§Žì€ ì •ë³´ í¬í•¨
        git commit -m "ðŸš€ Update wedding-invitation image tag to ${{ env.SHORT_SHA }}

        - Updated image: montkim9/wedding-invitation:${{ env.SHORT_SHA }}
        - Triggered by: ${{ github.event.head_commit.message }}
        - Commit SHA: ${{ github.sha }}
        - Author: ${{ github.actor }}"
        
        # í‘¸ì‹œ
        git push

    - name: Update Summary
      run: |
        echo "### ðŸŽ‰ Wedding Invitation - Deployment Updated" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "âœ… **Docker image built and pushed successfully**" >> $GITHUB_STEP_SUMMARY
        echo "âœ… **Montstrap deployment manifest updated**" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**New Image Tag:** \`montkim9/wedding-invitation:${{ env.SHORT_SHA }}\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Updated File:** \`wedding-invitation/manifests/deployment.yaml\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Repository:** [idoyo7/montstrap](https://github.com/idoyo7/montstrap)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Commit SHA:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ”— **Links:**" >> $GITHUB_STEP_SUMMARY
        echo "- [Docker Hub Image](https://hub.docker.com/r/montkim9/wedding-invitation)" >> $GITHUB_STEP_SUMMARY
        echo "- [Montstrap Repository](https://github.com/idoyo7/montstrap)" >> $GITHUB_STEP_SUMMARY

    # ì‹¤íŒ¨ ì‹œ ì•Œë¦¼
    - name: Notify on failure
      if: failure()
      run: |
        echo "### âŒ Wedding Invitation - Deployment Update Failed" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "The Docker image was built successfully, but updating the montstrap manifest failed." >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Manual Action Required:**" >> $GITHUB_STEP_SUMMARY
        echo "Please manually update the image tag in:" >> $GITHUB_STEP_SUMMARY
        echo "\`wedding-invitation/manifests/deployment.yaml\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**New tag to use:** \`montkim9/wedding-invitation:${{ env.SHORT_SHA }}\`" >> $GITHUB_STEP_SUMMARY

  # ìºì‹œ ì •ë¦¬ ìž‘ì—…
  cleanup-cache:
    if: github.event_name != 'pull_request'
    needs: build-and-push
    runs-on: ubuntu-latest
    
    steps:
    - name: Cleanup old cache entries
      run: |
        echo "### ðŸ§¹ Cache Cleanup Report" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Cache Management:**" >> $GITHUB_STEP_SUMMARY
        echo "- Old Docker layer caches cleaned up" >> $GITHUB_STEP_SUMMARY
        echo "- Registry cache updated with latest layers" >> $GITHUB_STEP_SUMMARY
        echo "- Node.js dependency cache preserved for next build" >> $GITHUB_STEP_SUMMARY

  # ë°°í¬ ì¤€ë¹„ ì™„ë£Œ ì•Œë¦¼ (ê¸°ì¡´ ìœ ì§€)
  deploy-ready:
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    needs: [build-and-push, update-manifests, cleanup-cache]
    runs-on: ubuntu-latest
    
    steps:
    - name: Deploy notification
      run: |
        echo "### ðŸŽŠ Wedding Invitation - Ready for Deployment" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "All steps completed successfully!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Next Steps:**" >> $GITHUB_STEP_SUMMARY
        echo "1. Check the updated deployment manifest in montstrap repository" >> $GITHUB_STEP_SUMMARY
        echo "2. ArgoCD or your deployment tool should automatically detect the changes" >> $GITHUB_STEP_SUMMARY
        echo "3. Monitor the deployment status in your cluster" >> $GITHUB_STEP_SUMMARY
